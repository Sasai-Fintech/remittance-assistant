# Key Engineering Decisions

| #   | Decision                                         | Context & Rationale                                                                                                                                                                                     | Implications / Follow-ups                                                                                                      |
| --- | ------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------ |
| 1   | **JWT passthrough only (no verification yet)**   | The mobile shell already guarantees JWT authenticity. For the MVP we simply forward the raw token from the widget → CopilotKit → AgentOS → MCP so downstream wallet/ticket APIs can authorize requests. | Add JWKS validation + expiry enforcement before production; document header name (`Authorization` / configurable).             |
| 2   | **Official OpenAI SDK (`openai==2.8.1`)**        | Agno v2.2.13 expects the new `openai.types.responses` package. Upgrading the backend SDK removed the need for a custom compatibility shim.                                                              | Keep backend requirements pinned to `2.8.1`+; if Agno bumps again we can upgrade in place without shims.                       |
| 3   | **FastMCP-in-process tooling**                   | The dummy wallet/ticket APIs run via FastMCP `stdio` inside the backend process, simplifying local dev and tests.                                                                                       | Swap the command/env to point at real MCP endpoints later; keep tool name prefix `eco_` stable for prompts.                    |
| 4   | **Shared schema package for AG-UI widgets**      | Frontend (Zod) and backend (Pydantic) both import `@ecocash/schemas`, ensuring render_widget/request_confirmation payloads stay consistent.                                                             | When adding new widgets, update `packages/schemas` first, then backend `agent/widgets.py`, then frontend renderer.             |
| 5   | **CopilotKit runtime proxy (`/api/copilotkit`)** | Instead of calling the backend directly from the browser, CopilotKit’s Next.js route forwards AG-UI traffic and injects headers (JWT, metadata).                                                        | Any new headers (e.g., device info) should be added here. The runtime URL is set via `NEXT_PUBLIC_COPILOTKIT_RUNTIME_URL`.     |
| 6   | **Mobile wrapper for E2E testing**               | `frontend/public/mobile-wrapper.html` simulates the native container by injecting JWT + metadata, letting anyone test the entire flow without the mobile app.                                           | Keep this page in sync with any new token/query requirements; it doubles as a demo harness.                                    |
| 7   | **Widget tool handshake**                        | `render_widget` and `request_confirmation` actions now use `renderAndWaitForResponse`, returning schema-validated payloads and sending a single acknowledgement back to the agent before rendering.     | When adding new AG-UI actions, follow the same pattern (validate → respond once → render) to avoid “external execution” loops. |
| 8   | **Docs-as-source-of-truth**                      | README, PRD, architecture, milestones, and this decisions log must be updated with every major change so additional Cursor agents can orient quickly.                                                   | Treat these docs as part of the code review checklist; any feature touching architecture should include a doc update.          |

_Last updated: 2025-11-19_
